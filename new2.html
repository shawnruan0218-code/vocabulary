<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>单词造句 & 句子库</title>
  <!-- 关键：让手机按设备宽度自适应，而不是当成电脑网页缩放 -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Segoe UI", Roboto, "PingFang SC", "Microsoft Yahei", sans-serif;
      background: #f5f5f7;
      color: #111827;
      font-size: 15px;
    }
    .app {
      max-width: 1320px;
      margin: 0 auto;
      padding: 16px 16px 56px;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
      margin-bottom: 12px;
      gap: 8px;
      flex-wrap: wrap;
    }
    header h1 {
      margin: 0;
      font-size: 24px;
      font-weight: 700;
      color: #111827;
      letter-spacing: 0.02em;
    }
    header .subtitle {
      font-size: 13px;
      color: #6b7280;
      margin-top: 4px;
    }

    .view-tabs {
      display: inline-flex;
      padding: 4px;
      border-radius: 999px;
      background: rgba(255,255,255,0.8);
      box-shadow: 0 6px 18px rgba(15,23,42,0.08);
      margin-bottom: 14px;
      gap: 4px;
    }
    .view-tab {
      border-radius: 999px;
      border: none;
      background: transparent;
      padding: 6px 16px;
      font-size: 13px;
      cursor: pointer;
      color: #4b5563;
      transition: 0.15s background, 0.15s color, 0.15s box-shadow, 0.15s transform;
    }
    .view-tab.active {
      background: #ffffff;
      color: #007aff;
      box-shadow: 0 4px 12px rgba(15,23,42,0.12);
      transform: translateY(-1px);
    }

    .main-layout {
      display: flex;
      flex-wrap: wrap;
      gap: 14px;
    }
    .panel {
      background: #ffffff;
      border-radius: 18px;
      padding: 18px;
      box-shadow: 0 14px 30px rgba(15, 23, 42, 0.08);
      flex: 1 1 340px;
      min-width: 280px;
    }
    .view-panel {
      display: none;
    }
    .view-panel.active {
      display: block;
    }

    .panel h2 {
      margin-top: 0;
      font-size: 18px;
      margin-bottom: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: 600;
      color: #111827;
    }
    .panel h2 span {
      font-size: 11px;
      font-weight: 400;
      color: #9ca3af;
    }

    .panel-header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
      flex-wrap: wrap;
    }

    .input-row {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }
    .input-row input[type="text"] {
      flex: 1;
      padding: 10px 14px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      font-size: 15px;
      outline: none;
      transition: 0.2s border, 0.2s box-shadow, 0.2s background;
      background: #f9fafb;
    }
    .input-row input[type="text"]:focus {
      border-color: #007aff;
      box-shadow: 0 0 0 2px rgba(0, 122, 255, 0.2);
      background: #ffffff;
    }

    .btn {
      border: none;
      border-radius: 999px;
      padding: 9px 16px;
      font-size: 13px;
      cursor: pointer;
      background: #007aff;
      color: #ffffff;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: 0.15s transform, 0.15s box-shadow, 0.15s background;
      white-space: nowrap;
    }
    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 18px rgba(0, 122, 255, 0.35);
      background: #0062cc;
    }
    .btn:disabled {
      opacity: 0.55;
      cursor: default;
      box-shadow: none;
      transform: none;
    }
    .btn-secondary {
      background: #f3f4f6;
      color: #111827;
      border: 1px solid #d1d5db;
      box-shadow: none;
    }
    .btn-secondary:hover {
      background: #e5e7eb;
      box-shadow: 0 3px 10px rgba(15, 23, 42, 0.15);
    }
    .btn-sm {
      padding: 5px 10px;
      font-size: 11px;
      border-radius: 999px;
    }

    .hint {
      font-size: 12px;
      color: #6b7280;
      margin-bottom: 8px;
      line-height: 1.5;
    }
    .status {
      font-size: 13px;
      margin-top: 4px;
      min-height: 18px;
      color: #4b5563;
    }
    .status.ok {
      color: #059669;
    }
    .status.error {
      color: #b91c1c;
    }

    .block-title {
      font-size: 13px;
      font-weight: 600;
      margin: 10px 0 6px;
      color: #4b5563;
    }

    .current-result {
      border-radius: 12px;
      border: 1px dashed #d1d5db;
      padding: 12px;
      margin-top: 4px;
      background: #f9fafb;
      max-height: 260px;
      overflow: auto;
      font-size: 14px;
    }
    .current-result.empty {
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 13px;
      color: #9ca3af;
    }

    .sentence-card {
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      padding: 8px 10px;
      margin-bottom: 8px;
      background: linear-gradient(135deg, #ffffff, #f9fafb);
    }
    .sentence-word {
      font-size: 14px;
      font-weight: 700;
      color: #111827;
      margin-bottom: 2px;
    }
    .word-meaning {
      font-size: 13px;
      color: #4b5563;
      margin-bottom: 6px;
    }
    .sentence-en {
      font-size: 14px;
      margin-bottom: 2px;
      color: #111827;
    }
    .sentence-zh {
      font-size: 13px;
      color: #6b7280;
    }
    .sentence-progress {
      font-size: 12px;
      color: #2563eb;
      margin-top: 4px;
    }

    .sentence-list {
      max-height: 420px;
      overflow: auto;
      padding-right: 6px;
    }

    .sentence-row {
      display: flex;
      align-items: flex-start;
      gap: 6px;
      margin-bottom: 4px;
    }
    .sentence-select {
      margin-top: 4px;
      cursor: pointer;
    }

    .word-tabs {
      display: flex;
      gap: 6px;
      margin-bottom: 8px;
      flex-wrap: wrap;
    }
    .word-tab-btn {
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      background: #f3f4f6;
      padding: 4px 12px;
      font-size: 12px;
      cursor: pointer;
      color: #4b5563;
      transition: 0.15s background, 0.15s color, 0.15s border;
    }
    .word-tab-btn.active {
      background: #007aff;
      color: #ffffff;
      border-color: #007aff;
    }

    .word-search-row {
      margin-bottom: 8px;
    }
    .word-search-row input {
      width: 100%;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      font-size: 13px;
      outline: none;
      background: #f9fafb;
      transition: 0.2s border, 0.2s box-shadow, 0.2s background;
    }
    .word-search-row input:focus {
      border-color: #007aff;
      box-shadow: 0 0 0 2px rgba(0, 122, 255, 0.2);
      background: #ffffff;
    }

    .word-list {
      max-height: 280px;
      overflow: auto;
      padding-right: 6px;
      margin-bottom: 10px;
    }
    .word-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-radius: 999px;
      padding: 7px 10px;
      margin-bottom: 6px;
      background: #f9fafb;
      cursor: pointer;
      border: 1px solid transparent;
      transition: 0.12s background, 0.12s border, 0.12s box-shadow;
    }
    .word-item:hover {
      background: #eef2ff;
    }
    .word-item.selected {
      border-color: #007aff;
      box-shadow: 0 0 0 1px rgba(0, 122, 255, 0.35);
    }
    .word-main {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .word-text {
      font-size: 14px;
      font-weight: 600;
      color: #111827;
    }
    .word-meta {
      font-size: 11px;
      color: #6b7280;
    }
    .word-stage-tag {
      display: inline-block;
      border-radius: 999px;
      padding: 1px 6px;
      font-size: 10px;
      margin-left: 4px;
    }
    .stage-0 {
      background: #e5e7eb;
      color: #4b5563;
    }
    .stage-1 {
      background: #fee2e2;
      color: #b91c1c;
    }
    .stage-2 {
      background: #fef3c7;
      color: #92400e;
    }
    .stage-3 {
      background: #dcfce7;
      color: #15803d;
    }
    .word-actions {
      display: flex;
      gap: 4px;
      flex-wrap: nowrap;
    }

    .word-detail {
      border-radius: 12px;
      border: 1px dashed #d1d5db;
      padding: 10px;
      min-height: 72px;
      background: #f9fafb;
      margin-bottom: 10px;
      max-height: 220px;
      overflow: auto;
    }
    .word-detail-title {
      font-size: 13px;
      margin-bottom: 4px;
      color: #4b5563;
    }

    .export-group {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .api-settings {
      margin-top: 8px;
      border-radius: 14px;
      background: #f3f4ff;
      padding: 10px 12px;
      border: 1px solid #d4dcff;
      font-size: 11px;
    }
    .api-settings-toggle {
      font-size: 11px;
      cursor: pointer;
      color: #007aff;
      text-decoration: underline;
      margin-top: 6px;
      user-select: none;
    }
    .api-settings-row {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-top: 6px;
    }
    .api-settings-row label {
      font-size: 11px;
      color: #4b5563;
    }
    .api-settings-row input,
    .api-settings-row select {
      width: 100%;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid #c7d2fe;
      font-size: 12px;
      background: #ffffff;
      outline: none;
      transition: 0.2s border, 0.2s box-shadow;
    }
    .api-settings-row input:focus,
    .api-settings-row select:focus {
      border-color: #007aff;
      box-shadow: 0 0 0 2px rgba(0, 122, 255, 0.18);
    }

    @media (max-width: 900px) {
      header h1 {
        font-size: 21px;
      }
      .panel {
        flex: 1 1 100%;
      }
      .view-tabs {
        width: 100%;
        justify-content: center;
      }
    }

    @media (max-width: 600px) {
      body {
        font-size: 14px;
      }
      .app {
        padding: 12px 10px 40px;
      }
      header h1 {
        font-size: 19px;
      }
      .panel {
        padding: 14px;
        border-radius: 14px;
        box-shadow: 0 10px 20px rgba(15,23,42,0.06);
      }
      .input-row {
        flex-direction: column;
      }
      .btn {
        justify-content: center;
      }
      .main-layout {
        gap: 10px;
      }
    }

    @media print {
      body {
        background: #fff;
      }
      .app {
        max-width: none;
        padding: 0;
      }
      header,
      .view-tabs,
      #input-panel,
      #sentence-panel,
      #word-panel {
        display: none !important;
      }
      .panel {
        box-shadow: none;
        border-radius: 0;
      }

      #print-container {
        display: none;
      }
      body[data-print-mode="sentenceLib"] #print-container {
        display: block !important;
        padding: 16px 24px;
        font-size: 14px;
      }

      body[data-print-mode="wordAll"] #word-panel,
      body[data-print-mode="stage1"] #word-panel,
      body[data-print-mode="stage2"] #word-panel,
      body[data-print-mode="stage3"] #word-panel {
        display: block !important;
      }

      button,
      .word-tabs,
      .word-search-row,
      .api-settings,
      .api-settings-toggle,
      .hint,
      .status,
      .sentence-select {
        display: none !important;
      }

      .word-list,
      .sentence-list,
      .word-detail {
        max-height: none !important;
        overflow: visible !important;
      }
    }

    .print-word-block {
      margin-bottom: 18px;
      page-break-inside: avoid;
    }
    .print-word-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 4px;
    }
    .print-word-meaning {
      font-size: 13px;
      margin-bottom: 6px;
    }
    .print-sentence-en {
      font-size: 14px;
    }
    .print-sentence-zh {
      font-size: 13px;
      color: #555;
      margin-bottom: 4px;
    }
  </style>
</head>
<body data-print-mode="">
  <div class="app">
    <header>
      <div>
        <h1>单词造句 & 句子库</h1>
        <div class="subtitle"></div>
      </div>
    </header>

    <nav class="view-tabs">
      <button class="view-tab active" data-view="input">造句</button>
      <button class="view-tab" data-view="sentence">句子库</button>
      <button class="view-tab" data-view="word">单词库 / 错题集</button>
    </nav>

    <main class="main-layout">
      <!-- 造句 -->
      <section class="panel view-panel active" id="input-panel" data-view="input">
        <h2>
          单词输入 & 造句
          <span>回车即可生成</span>
        </h2>
        <div class="input-row">
          <input id="word-input" type="text" placeholder="输入英文单词，如：compile，然后回车" />
          <button class="btn" id="generate-btn">生成句子</button>
        </div>
        <div class="status" id="status-text"></div>

        <div class="block-title">最近一次完成的结果</div>
        <div class="current-result empty" id="current-result">
          还没有结果，先在上面输入一个单词试试～</div>

        <div class="api-settings-toggle" id="api-settings-toggle">
          ▶ 展开 / 收起 API 设置（硅基流动 · DeepSeek）
        </div>
        <div class="api-settings" id="api-settings" style="display:none;">
          <div style="margin-bottom:4px;">
            接口地址已内置：<b>https://api.siliconflow.cn/v1/chat/completions</b>
          </div>

          <div class="api-settings-row">
            <label>API Key</label>
            <input type="text" id="api-key" placeholder="粘贴你的 API Key（只保存在本地浏览器）" />
          </div>

          <div class="api-settings-row">
            <label>模型名称</label>
            <input type="text" id="api-model" placeholder="例如：deepseek-ai/DeepSeek-R1" />
            <select id="api-model-presets">
              <option value="">（可选）从这里快速选择常用模型</option>
              <option value="deepseek-ai/DeepSeek-R1">deepseek-ai/DeepSeek-R1</option>
              <option value="deepseek-ai/DeepSeek-V3">deepseek-ai/DeepSeek-V3</option>
              <option value="deepseek-ai/DeepSeek-V2.5">deepseek-ai/DeepSeek-V2.5</option>
              <option value="Qwen/Qwen2.5-32B-Instruct">Qwen/Qwen2.5-32B-Instruct</option>
              <option value="Qwen/Qwen2.5-14B-Instruct">Qwen/Qwen2.5-14B-Instruct</option>
              <option value="Qwen/Qwen2.5-7B-Instruct">Qwen/Qwen2.5-7B-Instruct</option>
            </select>
          </div>

          <div style="margin-top:8px; display:flex; flex-wrap:wrap; gap:6px; align-items:center;">
            <button class="btn btn-sm btn-secondary" id="save-api-btn">保存 API 设置</button>
            <button class="btn btn-sm btn-secondary" id="test-api-btn">测试 API</button>
            <span id="api-save-status" class="status ok" style="margin-top:0;"></span>
            <span id="api-test-status" class="status" style="margin-top:0;"></span>
          </div>
        </div>
      </section>

      <!-- 句子库 -->
      <section class="panel view-panel" id="sentence-panel" data-view="sentence">
        <div class="panel-header-row">
          <h2>句子库 <span>勾选后再导出</span></h2>
          <button class="btn btn-sm btn-secondary" id="export-sentence-pdf-btn">
            导出勾选句子 PDF
          </button>
        </div>
        <div class="sentence-list" id="sentence-library"></div>
      </section>

      <!-- 单词库 -->
      <section class="panel view-panel" id="word-panel" data-view="word">
        <h2>单词库 & 错题集</h2>
        <div class="word-tabs">
          <button class="word-tab-btn active" data-tab="all">全部单词</button>
          <button class="word-tab-btn" data-tab="stage1">第一次</button>
          <button class="word-tab-btn" data-tab="stage2">第二次</button>
          <button class="word-tab-btn" data-tab="stage3">第三次</button>
        </div>
        <div class="word-search-row">
          <input id="word-search" type="text" placeholder="搜索单词（跨全部分组检索）" />
        </div>
        <div class="word-list" id="word-list"></div>

        <div class="word-detail" id="word-detail">
          <div class="word-detail-title">
            点击左侧单词，可以在这里查看常见意思和已勾选的例句。
          </div>
        </div>

        <div class="export-group">
          <button class="btn btn-sm btn-secondary" id="export-words-pdf-btn">
            导出「全部单词」PDF
          </button>
          <button class="btn btn-sm btn-secondary" id="export-stage1-pdf-btn">
            导出「第一次」PDF
          </button>
          <button class="btn btn-sm btn-secondary" id="export-stage2-pdf-btn">
            导出「第二次」PDF
          </button>
          <button class="btn btn-sm btn-secondary" id="export-stage3-pdf-btn">
            导出「第三次」PDF
          </button>
        </div>

        <div class="export-group" style="margin-top:8px;">
          <button class="btn btn-sm btn-secondary" id="export-data-btn">
            导出全部数据(JSON)
          </button>
          <button class="btn btn-sm btn-secondary" id="import-data-btn">
            导入数据(JSON)
          </button>
          <input type="file" id="import-file-input" accept="application/json" style="display:none;">
        </div>
      </section>
    </main>

    <div id="print-container" style="display:none;"></div>
  </div>

  <script>
    const STORAGE_KEY_STATE = "vocab_app_state_v5";
    const STORAGE_KEY_API = "vocab_app_api_v5";
    const DEFAULT_BASE_URL = "https://api.siliconflow.cn/v1/chat/completions";

    let appState = {
      words: [],
      sentenceQueue: []
    };

    let uiState = {
      currentTab: "all",
      selectedWordId: null,
      currentView: "input",
      wordSearchQuery: ""
    };

    let generatingTasks = {};

    let apiConfig = {
      baseUrl: DEFAULT_BASE_URL,
      apiKey: "",
      model: ""
    };

    function normalizeWord(word) {
      return word.trim();
    }
    function findWordById(id) {
      return appState.words.find(w => w.id === id) || null;
    }
    function saveState() {
      const toSave = {
        words: appState.words,
        sentenceQueue: appState.sentenceQueue
      };
      localStorage.setItem(STORAGE_KEY_STATE, JSON.stringify(toSave));
    }
    function loadState() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY_STATE);
        if (raw) {
          const parsed = JSON.parse(raw);
          if (Array.isArray(parsed.words)) {
            appState.words = parsed.words.map(w => ({
              id: w.id,
              text: w.text,
              meaningZh: w.meaningZh || "",
              sentences: Array.isArray(w.sentences)
                ? w.sentences.map(s => ({
                    en: (s.en || "").toString(),
                    zh: (s.zh || "").toString(),
                    selectedForExport: !!s.selectedForExport
                  }))
                : [],
              stage: typeof w.stage === "number" ? w.stage : 0,
              createdAt: w.createdAt || new Date().toISOString()
            }));
          }
          if (Array.isArray(parsed.sentenceQueue)) {
            appState.sentenceQueue = parsed.sentenceQueue;
          }
        }
      } catch (e) {
        console.error("加载状态失败", e);
      }
    }
    function saveApiConfig() {
      localStorage.setItem(STORAGE_KEY_API, JSON.stringify(apiConfig));
    }
    function loadApiConfig() {
      apiConfig.baseUrl = DEFAULT_BASE_URL;
      try {
        const raw = localStorage.getItem(STORAGE_KEY_API);
        if (raw) {
          const parsed = JSON.parse(raw);
          apiConfig.apiKey = parsed.apiKey || "";
          apiConfig.model = parsed.model || "";
        }
      } catch (e) {
        console.error("加载 API 配置失败", e);
      }
    }
    function syncApiConfigFromInputs() {
      const keyInput = document.getElementById("api-key");
      const modelInput = document.getElementById("api-model");
      apiConfig.apiKey = (keyInput.value || "").trim();
      apiConfig.model = (modelInput.value || "").trim();
      apiConfig.baseUrl = DEFAULT_BASE_URL;
    }
    function stageLabel(stage) {
      switch (stage) {
        case 1: return "第一次";
        case 2: return "第二次";
        case 3: return "第三次";
        default: return "未归类";
      }
    }
    function setStatus(message, type = "") {
      const el = document.getElementById("status-text");
      el.textContent = message || "";
      el.classList.remove("ok", "error");
      if (type === "ok") el.classList.add("ok");
      if (type === "error") el.classList.add("error");
    }
    function hasValidApiConfig() {
      return apiConfig.baseUrl && apiConfig.apiKey && apiConfig.model;
    }
    function normalizeSentences(rawSentences) {
      return (rawSentences || [])
        .map(s => ({
          en: (s.en || "").toString().trim(),
          zh: (s.zh || "").toString().trim(),
          selectedForExport: !!s.selectedForExport
        }))
        .filter(s => s.en);
    }
    function escapeHtml(str) {
      return (str || "").toString()
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#39;");
    }

    function renderCurrentResult(wordObj) {
      const container = document.getElementById("current-result");
      container.innerHTML = "";
      if (!wordObj || !Array.isArray(wordObj.sentences) || wordObj.sentences.length === 0) {
        container.classList.add("empty");
        container.textContent = "还没有结果，先在上面输入一个单词试试～";
        return;
      }
      container.classList.remove("empty");
      const title = document.createElement("div");
      title.className = "sentence-word";
      title.textContent = `${wordObj.text} · 常见意思与例句`;
      container.appendChild(title);

      if (wordObj.meaningZh) {
        const m = document.createElement("div");
        m.className = "word-meaning";
        m.textContent = wordObj.meaningZh;
        container.appendChild(m);
      }

      wordObj.sentences.forEach((s, idx) => {
        const card = document.createElement("div");
        card.className = "sentence-card";
        const en = document.createElement("div");
        en.className = "sentence-en";
        en.textContent = (idx + 1) + ". " + (s.en || "");
        const zh = document.createElement("div");
        zh.className = "sentence-zh";
        zh.textContent = s.zh || "";
        card.appendChild(en);
        card.appendChild(zh);
        container.appendChild(card);
      });
    }

    function renderSentenceLibrary() {
      const container = document.getElementById("sentence-library");
      container.innerHTML = "";
      if (!appState.sentenceQueue.length) {
        const div = document.createElement("div");
        div.className = "hint";
        div.textContent = "当前句子库为空。";
        container.appendChild(div);
        return;
      }
      const uniqueIds = [...new Set(appState.sentenceQueue)];
      uniqueIds.forEach(id => {
        const wordObj = findWordById(id);
        if (!wordObj) return;
        const wrapper = document.createElement("div");
        wrapper.className = "sentence-card";
        wrapper.dataset.wordId = id;

        const w = document.createElement("div");
        w.className = "sentence-word";
        w.textContent = wordObj.text;
        wrapper.appendChild(w);

        if (wordObj.meaningZh) {
          const m = document.createElement("div");
          m.className = "word-meaning";
          m.textContent = wordObj.meaningZh;
          wrapper.appendChild(m);
        }

        const isGenerating = !!generatingTasks[id];

        if (!wordObj.sentences || wordObj.sentences.length === 0) {
          const info = document.createElement("div");
          info.className = "sentence-progress";
          info.textContent = isGenerating
            ? (generatingTasks[id] || "正在为该单词生成句子…")
            : "当前尚未为该单词生成句子。";
          wrapper.appendChild(info);
        } else {
          wordObj.sentences.forEach((s, idx) => {
            const row = document.createElement("div");
            row.className = "sentence-row";
            row.dataset.wordId = id;
            row.dataset.index = String(idx);
            row.dataset.selected = s.selectedForExport ? "true" : "false";

            const check = document.createElement("input");
            check.type = "checkbox";
            check.className = "sentence-select";
            check.checked = !!s.selectedForExport;
            check.dataset.wordId = id;
            check.dataset.index = String(idx);

            const textWrap = document.createElement("div");
            const en = document.createElement("div");
            en.className = "sentence-en";
            en.textContent = (idx + 1) + ". " + (s.en || "");
            const zh = document.createElement("div");
            zh.className = "sentence-zh";
            zh.textContent = s.zh || "";
            textWrap.appendChild(en);
            textWrap.appendChild(zh);

            row.appendChild(check);
            row.appendChild(textWrap);
            wrapper.appendChild(row);
          });

          if (isGenerating) {
            const info = document.createElement("div");
            info.className = "sentence-progress";
            info.textContent = generatingTasks[id] || "正在为该单词追加句子…";
            wrapper.appendChild(info);
          }
        }

        container.appendChild(wrapper);
      });
    }

    function renderWordList() {
      const list = document.getElementById("word-list");
      list.innerHTML = "";
      const query = (uiState.wordSearchQuery || "").toLowerCase();

      let wordsToShow = [];

      if (query) {
        wordsToShow = appState.words.filter(w =>
          (w.text || "").toLowerCase().includes(query)
        );
      } else {
        if (uiState.currentTab === "stage1") {
          wordsToShow = appState.words.filter(w => w.stage === 1);
        } else if (uiState.currentTab === "stage2") {
          wordsToShow = appState.words.filter(w => w.stage === 2);
        } else if (uiState.currentTab === "stage3") {
          wordsToShow = appState.words.filter(w => w.stage === 3);
        } else {
          wordsToShow = appState.words.filter(w => !w.stage || w.stage === 0);
        }
      }

      if (!wordsToShow.length) {
        const div = document.createElement("div");
        div.className = "hint";
        if (query) {
          div.textContent = `未找到包含「${uiState.wordSearchQuery}」的单词。`;
        } else {
          div.textContent = "这里还没有单词。";
        }
        list.appendChild(div);
        return;
      }

      wordsToShow.forEach(word => {
        const item = document.createElement("div");
        item.className = "word-item";
        item.dataset.id = word.id;
        if (uiState.selectedWordId === word.id) {
          item.classList.add("selected");
        }

        const main = document.createElement("div");
        main.className = "word-main";

        const text = document.createElement("div");
        text.className = "word-text";
        text.textContent = word.text;

        const meta = document.createElement("div");
        meta.className = "word-meta";
        const stageTag = document.createElement("span");
        stageTag.className = "word-stage-tag stage-" + (word.stage || 0);
        stageTag.textContent = stageLabel(word.stage || 0);

        const selectedCount = (word.sentences || []).filter(s => s.selectedForExport).length;
        meta.textContent = "已选例句：" + selectedCount + " 条";
        meta.appendChild(stageTag);

        main.appendChild(text);
        main.appendChild(meta);

        const actions = document.createElement("div");
        actions.className = "word-actions";

        [1, 2, 3].forEach(stage => {
          const btn = document.createElement("button");
          btn.className = "btn btn-sm btn-secondary";
          btn.textContent = stage + "次";
          btn.dataset.stage = String(stage);
          actions.appendChild(btn);
        });

        const delBtn = document.createElement("button");
        delBtn.className = "btn btn-sm btn-secondary";
        delBtn.textContent = "删除";
        delBtn.dataset.action = "delete";
        actions.appendChild(delBtn);

        item.appendChild(main);
        item.appendChild(actions);
        list.appendChild(item);
      });
    }

    function renderWordDetail() {
      const container = document.getElementById("word-detail");
      container.innerHTML = "";
      const wordObj = findWordById(uiState.selectedWordId);
      if (!wordObj) {
        const div = document.createElement("div");
        div.className = "word-detail-title";
        div.textContent = "点击左侧单词，可以在这里查看常见意思和已勾选的例句。";
        container.appendChild(div);
        return;
      }
      const title = document.createElement("div");
      title.className = "word-detail-title";
      title.textContent = `单词：${wordObj.text} · 阶段：${stageLabel(wordObj.stage || 0)}`;
      container.appendChild(title);

      if (wordObj.meaningZh) {
        const m = document.createElement("div");
        m.className = "word-meaning";
        m.textContent = wordObj.meaningZh;
        container.appendChild(m);
      }

      const selectedSentences = (wordObj.sentences || []).filter(s => s.selectedForExport);

      if (!selectedSentences.length) {
        const div = document.createElement("div");
        div.className = "hint";
        div.textContent = "这个单词还没有勾选例句。请先在「句子库」里勾选要保留的句子。";
        container.appendChild(div);
        return;
      }

      selectedSentences.forEach((s, idx) => {
        const card = document.createElement("div");
        card.className = "sentence-card";
        const en = document.createElement("div");
        en.className = "sentence-en";
        en.textContent = (idx + 1) + ". " + (s.en || "");
        const zh = document.createElement("div");
        zh.className = "sentence-zh";
        zh.textContent = s.zh || "";
        card.appendChild(en);
        card.appendChild(zh);
        container.appendChild(card);
      });
    }

    function renderTabs() {
      const buttons = document.querySelectorAll(".word-tab-btn");
      buttons.forEach(btn => {
        if (btn.dataset.tab === uiState.currentTab) {
          btn.classList.add("active");
        } else {
          btn.classList.remove("active");
        }
      });
    }

    function switchView(view) {
      uiState.currentView = view;
      document.querySelectorAll(".view-tab").forEach(btn => {
        btn.classList.toggle("active", btn.dataset.view === view);
      });
      document.querySelectorAll(".view-panel").forEach(panel => {
        panel.classList.toggle("active", panel.dataset.view === view);
      });
    }

    async function callApiForWordData(wordText) {
      const prompt = `
你是一名英语老师，帮助中文母语学习者理解英文单词。

请针对英文单词 "${wordText}" 输出该词最常见的中文意思（偏学习用法解释），并给出若干个简单、有画面感的英文例句，覆盖它最常见的主要含义。

要求：
1. 句子难度接近中小学水平，优先使用常见词汇。
2. 每个英文句子给出对应的中文翻译。
3. 使用 JSON 格式输出，形如：
{
  "meaning_zh": "常见意思：将不同的信息、数据等收集并整理成一份整体。",
  "sentences": [
    {"en": "英文句子1", "zh": "对应的中文翻译1"},
    {"en": "英文句子2", "zh": "对应的中文翻译2"}
  ]
}
只输出 JSON，不要多余说明。`.trim();

      const payload = {
        model: apiConfig.model,
        messages: [
          { role: "system", content: "You are a helpful English tutor." },
          { role: "user", content: prompt }
        ],
        temperature: 0.7,
        stream: false
      };

      const resp = await fetch(apiConfig.baseUrl, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": "Bearer " + apiConfig.apiKey
        },
        body: JSON.stringify(payload)
      });

      if (!resp.ok) {
        throw new Error("HTTP 状态码 " + resp.status);
      }
      const data = await resp.json();
      const content =
        data &&
        data.choices &&
        data.choices[0] &&
        data.choices[0].message &&
        data.choices[0].message.content
          ? data.choices[0].message.content
          : "";

      let meaningZh = "";
      let sentences = [];

      try {
        const trimmed = content.trim();
        const jsonText = trimmed
          .replace(/^```json/i, "")
          .replace(/^```/i, "")
          .replace(/```$/i, "")
          .trim();
        const parsed = JSON.parse(jsonText);
        if (parsed) {
          meaningZh = (parsed.meaning_zh || parsed.meaning || "").toString().trim();
          sentences = normalizeSentences(parsed.sentences || []);
        }
      } catch (e) {
        console.warn("解析 API 返回 JSON 失败，将尝试按行分割", e);
      }

      if (!sentences.length) {
        const lines = content.split("\n").map(l => l.trim()).filter(Boolean);
        const result = [];
        for (let i = 0; i < lines.length; i += 2) {
          const en = lines[i] || "";
          const zh = lines[i + 1] || "";
          if (en) {
            result.push({ en, zh });
          }
        }
        sentences = normalizeSentences(result);
      }

      return {
        meaningZh,
        sentences
      };
    }

    function localFallbackWordData(wordText) {
      const w = wordText;
      const meaningZh =
        "常见意思：略（当前使用本地示例句子，请根据词典补充具体含义）。";
      const sentences = normalizeSentences([
        {
          en: `I see a ${w} on the table.`,
          zh: `我看到桌子上有一个 ${w}。`
        },
        {
          en: `The little girl is holding a ${w} in her hand.`,
          zh: `小女孩手里拿着一个 ${w}。`
        },
        {
          en: `This ${w} makes me think of a warm afternoon.`,
          zh: `这个 ${w} 让我想起一个温暖的下午。`
        }
      ]);
      return { meaningZh, sentences };
    }

    async function testApiConnection() {
      const testStatus = document.getElementById("api-test-status");
      const saveStatus = document.getElementById("api-save-status");
      saveStatus.textContent = "";
      testStatus.classList.remove("ok", "error");

      syncApiConfigFromInputs();
      if (!hasValidApiConfig()) {
        testStatus.textContent = "请先填写 API Key 和模型名称。";
        testStatus.classList.add("error");
        return;
      }

      testStatus.textContent = "正在发送测试请求…";
      try {
        const payload = {
          model: apiConfig.model,
          messages: [
            { role: "system", content: "You are a helpful assistant." },
            { role: "user", content: "请简单回复一个“OK”用于测试。" }
          ],
          temperature: 0,
          stream: false
        };

        const resp = await fetch(apiConfig.baseUrl, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + apiConfig.apiKey
          },
          body: JSON.stringify(payload)
        });

        if (!resp.ok) {
          testStatus.textContent = "API 请求失败，HTTP 状态码：" + resp.status;
          testStatus.classList.add("error");
          return;
        }

        const data = await resp.json();
        const content =
          data &&
          data.choices &&
          data.choices[0] &&
          data.choices[0].message &&
          data.choices[0].message.content
            ? data.choices[0].message.content
            : "";
        testStatus.textContent = "API 测试成功。（返回示例：" + content.slice(0, 20) + "…）";
        testStatus.classList.add("ok");
        saveApiConfig();
      } catch (e) {
        console.error(e);
        testStatus.textContent =
          "API 请求未成功发出：" +
          e.message;
        testStatus.classList.add("error");
      }
    }

    async function generateSentencesForWord(rawWord) {
      const wordText = normalizeWord(rawWord);
      if (!wordText) {
        setStatus("请先输入一个单词～", "error");
        return;
      }

      const id = wordText.toLowerCase();
      const existing = findWordById(id);
      if (existing) {
        setStatus(`单词 ${existing.text} 已经存在于单词库中。`, "error");
        uiState.selectedWordId = id;
        renderWordList();
        renderWordDetail();
        renderCurrentResult(existing);
        return;
      }

      const inputEl = document.getElementById("word-input");
      inputEl.value = "";
      inputEl.focus();

      let wordObj = {
        id,
        text: wordText,
        meaningZh: "",
        sentences: [],
        stage: 0,
        createdAt: new Date().toISOString()
      };
      appState.words.push(wordObj);

      appState.sentenceQueue.push(id);
      generatingTasks[id] = hasValidApiConfig()
        ? "正在通过 API 生成句子…"
        : "正在使用本地示例生成句子…";

      setStatus(`已提交：${wordText}。可以继续输入下一个单词。`, "ok");

      renderSentenceLibrary();
      renderWordList();
      renderWordDetail();

      let wordData = null;
      let usedApi = false;

      try {
        if (hasValidApiConfig()) {
          usedApi = true;
          wordData = await callApiForWordData(wordText);
        }
      } catch (e) {
        console.error(e);
        setStatus("API 调用失败：" + e.message + "，已使用本地示例句子。", "error");
      }

      if (!wordData || !wordData.sentences || !wordData.sentences.length) {
        wordData = localFallbackWordData(wordText);
        if (!usedApi) {
          setStatus("当前未配置有效 API，已使用本地示例句子。", "ok");
        } else {
          setStatus("API 返回内容解析失败，已使用本地示例句子。", "error");
        }
      } else {
        setStatus("句子生成完成 √", "ok");
      }

      wordObj.meaningZh = wordData.meaningZh || wordObj.meaningZh || "";
      wordObj.sentences = normalizeSentences(wordData.sentences);

      generatingTasks[id] = undefined;
      delete generatingTasks[id];

      uiState.selectedWordId = id;
      saveState();
      renderCurrentResult(wordObj);
      renderSentenceLibrary();
      renderWordList();
      renderWordDetail();
    }

    function setWordStage(wordId, stage) {
      const w = findWordById(wordId);
      if (!w) return;
      w.stage = stage;
      saveState();
      renderWordList();
      renderWordDetail();
    }

    function deleteWord(wordId) {
      const idx = appState.words.findIndex(w => w.id === wordId);
      if (idx === -1) return;
      const wordText = appState.words[idx].text;

      appState.words.splice(idx, 1);
      appState.sentenceQueue = appState.sentenceQueue.filter(id => id !== wordId);
      if (uiState.selectedWordId === wordId) {
        uiState.selectedWordId = null;
      }

      saveState();
      renderWordList();
      renderWordDetail();
      renderSentenceLibrary();
      setStatus(`已删除单词：${wordText}`, "ok");
    }

    function handleWordListClick(event) {
      const target = event.target;
      const item = target.closest(".word-item");
      if (!item) return;
      const id = item.dataset.id;
      if (!id) return;

      if (target.matches("button") && target.dataset.stage) {
        const stage = parseInt(target.dataset.stage, 10);
        setWordStage(id, stage);
        const w = findWordById(id);
        setStatus(`已将 ${w.text} 归类到「第${stage}次」`, "ok");
        event.stopPropagation();
        return;
      }

      if (target.matches("button") && target.dataset.action === "delete") {
        deleteWord(id);
        event.stopPropagation();
        return;
      }

      uiState.selectedWordId = id;
      renderWordList();
      renderWordDetail();
    }

    function switchTab(tab) {
      uiState.currentTab = tab;
      renderTabs();
      renderWordList();
      renderWordDetail();
    }

    function handleSentenceSelectChange(event) {
      const target = event.target;
      if (!target.classList.contains("sentence-select")) return;
      const wordId = target.dataset.wordId;
      const index = parseInt(target.dataset.index, 10);
      const wordObj = findWordById(wordId);
      if (!wordObj || !wordObj.sentences || !wordObj.sentences[index]) return;
      wordObj.sentences[index].selectedForExport = target.checked;
      saveState();
      renderSentenceLibrary();
      renderWordList();
      renderWordDetail();
    }

    function exportSentenceLibraryToPdf() {
      if (!appState.sentenceQueue.length) {
        alert("当前句子库为空。");
        return;
      }

      const uniqueIds = [...new Set(appState.sentenceQueue)];
      const wordDataList = [];
      uniqueIds.forEach(id => {
        const w = findWordById(id);
        if (!w || !w.sentences) return;
        const selected = w.sentences.filter(s => s.selectedForExport);
        if (selected.length) {
          wordDataList.push({
            text: w.text,
            meaningZh: w.meaningZh || "",
            sentences: selected
          });
        }
      });

      if (!wordDataList.length) {
        alert("尚未勾选要导出的例句。");
        return;
      }

      const printContainer = document.getElementById("print-container");
      let html = '<h1 style="font-size:20px;margin-bottom:12px;">句子库导出</h1>';

      wordDataList.forEach(word => {
        html += '<div class="print-word-block">';
        html += '<div class="print-word-title">' + escapeHtml(word.text) + '</div>';

        if (word.meaningZh) {
          html += '<div class="print-word-meaning">常见意思：' + escapeHtml(word.meaningZh) + '</div>';
        }

        html += "<ol>";
        word.sentences.forEach(s => {
          html += "<li>";
          html += '<div class="print-sentence-en">' + escapeHtml(s.en) + "</div>";
          if (s.zh) {
            html += '<div class="print-sentence-zh">' + escapeHtml(s.zh) + "</div>";
          }
          html += "</li>";
        });
        html += "</ol>";
        html += "</div>";
      });

      printContainer.innerHTML = html;

      document.body.setAttribute("data-print-mode", "sentenceLib");
      window.print();
      document.body.setAttribute("data-print-mode", "");

      printContainer.innerHTML = "";
      appState.sentenceQueue = [];
      saveState();
      renderSentenceLibrary();
    }

    function exportWordsToPdf(mode) {
      const hasAnyWord = appState.words.length > 0;
      if (!hasAnyWord) {
        alert("当前单词库为空。");
        return;
      }
      if (mode === "stage1" && !appState.words.some(w => w.stage === 1)) {
        alert("第一次分组为空。");
        return;
      }
      if (mode === "stage2" && !appState.words.some(w => w.stage === 2)) {
        alert("第二次分组为空。");
        return;
      }
      if (mode === "stage3" && !appState.words.some(w => w.stage === 3)) {
        alert("第三次分组为空。");
        return;
      }
      document.body.setAttribute(
        "data-print-mode",
        mode === "all" ? "wordAll" : mode
      );
      window.print();
      document.body.setAttribute("data-print-mode", "");
    }

    function exportAllDataAsJson() {
      const data = {
        words: appState.words,
        sentenceQueue: appState.sentenceQueue
      };

      const blob = new Blob([JSON.stringify(data, null, 2)], {
        type: "application/json"
      });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "vocab-data.json";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function importDataFromJsonFile(file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const text = e.target.result;
          const obj = JSON.parse(text);

          if (!obj || !Array.isArray(obj.words)) {
            alert("导入失败：JSON 格式不正确。");
            return;
          }

          appState.words = obj.words.map(w => ({
            id: w.id,
            text: w.text,
            meaningZh: w.meaningZh || "",
            sentences: Array.isArray(w.sentences)
              ? w.sentences.map(s => ({
                  en: (s.en || "").toString(),
                  zh: (s.zh || "").toString(),
                  selectedForExport: !!s.selectedForExport
                }))
              : [],
            stage: typeof w.stage === "number" ? w.stage : 0,
            createdAt: w.createdAt || new Date().toISOString()
          }));

          appState.sentenceQueue = Array.isArray(obj.sentenceQueue)
            ? obj.sentenceQueue
            : [];

          saveState();
          renderTabs();
          renderWordList();
          renderWordDetail();
          renderSentenceLibrary();
          renderCurrentResult(null);
          setStatus("数据导入成功。", "ok");
        } catch (err) {
          alert("解析 JSON 失败：" + err.message);
        }
      };
      reader.readAsText(file);
    }

    function bindEvents() {
      const input = document.getElementById("word-input");
      const generateBtn = document.getElementById("generate-btn");

      input.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          generateSentencesForWord(input.value);
        }
      });
      generateBtn.addEventListener("click", () => {
        generateSentencesForWord(input.value);
      });

      document.querySelectorAll(".view-tab").forEach(btn => {
        btn.addEventListener("click", () => {
          switchView(btn.dataset.view);
        });
      });

      document.querySelectorAll(".word-tab-btn").forEach(btn => {
        btn.addEventListener("click", () => {
          switchTab(btn.dataset.tab);
        });
      });

      const wordSearchInput = document.getElementById("word-search");
      wordSearchInput.addEventListener("input", () => {
        uiState.wordSearchQuery = wordSearchInput.value.trim();
        renderWordList();
        renderWordDetail();
      });

      document.getElementById("word-list").addEventListener("click", handleWordListClick);
      document.getElementById("sentence-library").addEventListener("change", handleSentenceSelectChange);

      document
        .getElementById("export-sentence-pdf-btn")
        .addEventListener("click", exportSentenceLibraryToPdf);
      document
        .getElementById("export-words-pdf-btn")
        .addEventListener("click", () => exportWordsToPdf("all"));
      document
        .getElementById("export-stage1-pdf-btn")
        .addEventListener("click", () => exportWordsToPdf("stage1"));
      document
        .getElementById("export-stage2-pdf-btn")
        .addEventListener("click", () => exportWordsToPdf("stage2"));
      document
        .getElementById("export-stage3-pdf-btn")
        .addEventListener("click", () => exportWordsToPdf("stage3"));

      const apiToggle = document.getElementById("api-settings-toggle");
      const apiBox = document.getElementById("api-settings");
      apiToggle.addEventListener("click", () => {
        if (apiBox.style.display === "none") {
          apiBox.style.display = "block";
          apiToggle.textContent = "▼ 展开 / 收起 API 设置（硅基流动 · DeepSeek）";
        } else {
          apiBox.style.display = "none";
          apiToggle.textContent = "▶ 展开 / 收起 API 设置（硅基流动 · DeepSeek）";
        }
      });

      document.getElementById("save-api-btn").addEventListener("click", () => {
        syncApiConfigFromInputs();
        saveApiConfig();
        const tip = document.getElementById("api-save-status");
        tip.textContent = "已保存。";
        setTimeout(() => {
          tip.textContent = "";
        }, 2500);
      });

      document.getElementById("test-api-btn").addEventListener("click", () => {
        testApiConnection();
      });

      const presetSelect = document.getElementById("api-model-presets");
      presetSelect.addEventListener("change", () => {
        const val = presetSelect.value;
        if (val) {
          document.getElementById("api-model").value = val;
        }
      });

      const exportDataBtn = document.getElementById("export-data-btn");
      const importDataBtn = document.getElementById("import-data-btn");
      const importFileInput = document.getElementById("import-file-input");

      exportDataBtn.addEventListener("click", () => {
        exportAllDataAsJson();
      });

      importDataBtn.addEventListener("click", () => {
        importFileInput.click();
      });

      importFileInput.addEventListener("change", (e) => {
        const file = e.target.files[0];
        if (file) {
          importDataFromJsonFile(file);
          importFileInput.value = "";
        }
      });
    }

    function init() {
      loadState();
      loadApiConfig();

      document.getElementById("api-key").value = apiConfig.apiKey || "";
      document.getElementById("api-model").value = apiConfig.model || "";

      const wordSearchInput = document.getElementById("word-search");
      wordSearchInput.value = uiState.wordSearchQuery || "";

      renderTabs();
      renderWordList();
      renderWordDetail();
      renderSentenceLibrary();
      renderCurrentResult(null);
      switchView("input");
      bindEvents();
    }

    document.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</html>